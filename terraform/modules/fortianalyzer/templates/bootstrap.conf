# FortiAnalyzer Bootstrap Configuration
# CTF Fortinet - Phase 2 (Log Analysis & Incident Response)

config system admin
    edit "admin"
        set password ${admin_password}
        set trusthost1 0.0.0.0 0.0.0.0
        set accprofile "super_admin"
        set force-password-change disable
    next
end

config system global
    set hostname "${hostname}"
    set timezone "${timezone}"
    set admin-port 443
    set admin-sport 80
    set admin-https-redirect enable
    set gui-theme spring
end

config system dns
    set primary ${dns_primary}
    set secondary ${dns_secondary}
end

config system interface
    edit "port1"
        set mode static
        set allowaccess https ping ssh
        set type physical
    next
end

# Log Storage Configuration
config log-storage setting
    set max-log-age 7
    set max-log-age-unit day
    set status enable
    set rolling-analyzer enable
    set rolling-regular enable
end

# Device Registration for Teams
%{ for team_id, config in team_configs ~}
config device group
    edit "${team_id}"
        set desc "CTF Team ${team_id} - FortiGate Logs"
    next
end

config log eventfilter
    edit "${team_id}-events"
        set device "${team_id}"
        set filter-type include
        set severity information warning error critical alert emergency
    next
end
%{ endfor ~}

# Log Forwarding Configuration  
config log forwardservice
    edit "ctf-syslog"
        set mode real-time
        set facility local0
        set port 514
        set reliable enable
    next
end

# Report Scheduling for CTF
config report group
    edit "ctf-security-reports"
        set group-by device
        set report-layout table
    next
end

config report chart
    edit "top-attackers"
        set title "Top Attackers - CTF Analysis"
        set type table
        set category security
        set style auto
        set dimension 2d
        set drill-down enable
    next
    edit "security-events-timeline"
        set title "Security Events Timeline"
        set type line
        set category security
        set time-period last-24-hours
    next
    edit "threat-landscape" 
        set title "Threat Landscape Overview"
        set type pie
        set category security
        set style auto
    next
end

# User Accounts for CTF Teams
%{ for team_id, config in team_configs ~}
config system admin
    edit "${team_id}-analyst"
        set password "CTF${team_id}2026!"
        set accprofile "restricted_user"
        set rpc-permit read
        set trusthost1 0.0.0.0 0.0.0.0
        set force-password-change disable
        set description "CTF Team ${team_id} Analyst Account"
    next
end
%{ endfor ~}

# Custom Log Categories for CTF Analysis
config log threat-weight
    edit "apt-campaign"
        set level critical
        set category attack
        set type signature
    next
    edit "dns-tunneling"
        set level high
        set category command-control
        set type dns
    next
    edit "data-exfiltration"
        set level critical
        set category data-leak
        set type application
    next
end

# Automated Analysis Rules
config event-management rule
    edit "apt-detection"
        set status enable
        set event-type security
        set action email
        set severity high
        set description "APT Campaign Detection for CTF Analysis"
    next
    edit "dns-anomaly"
        set status enable 
        set event-type security
        set action log
        set severity medium
        set description "DNS Tunneling Pattern Detection"
    next
end

# Dashboard Configuration for CTF
config system dashboard
    edit "ctf-overview"
        set title "CTF Security Overview Dashboard"
        set layout-type dashboard
    next
end

config dashboard widget
    edit 1
        set title "Security Events (24h)"
        set type chart
        set size medium
        set visualization table
    next
    edit 2
        set title "Top Attack Sources"
        set type chart
        set size medium  
        set visualization pie
    next
    edit 3
        set title "Threat Timeline"
        set type chart
        set size large
        set visualization line
    next
    edit 4
        set title "Device Status"
        set type text
        set size small
    next
end