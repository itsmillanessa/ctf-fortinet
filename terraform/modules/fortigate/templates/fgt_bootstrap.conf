config system global
    set hostname "${hostname}"
    set admin-sport 443
    set admin-ssh-port 22
    set timezone 12
    set alias "${flag_recon}"
end

config system admin
    edit "admin"
        set password "${admin_password}"
        set accprofile "super_admin"
        set trusthost1 ${admin_cidr}
    next
    edit "ctfplayer"
        set password "CTFPlayer2026!"
        set accprofile "prof_admin"
        set trusthost1 0.0.0.0/0
        set comments "CTF participant account - Team ${team_name}"
    next
end

config system interface
    edit "port1"
        set alias "WAN"
        set mode dhcp
        set allowaccess ping https ssh http fgfm
        set description "WAN Interface"
    next
    edit "port2"
        set alias "LAN"
        set mode static
        set ip ${lan_ip} ${lan_mask}
        set allowaccess ping https ssh http
        set description "LAN Interface"
    next
    edit "port3"
        set alias "DMZ"
        set mode static
        set ip ${dmz_ip} ${dmz_mask}
        set allowaccess ping
        set description "DMZ Interface"
    next
end

config system dns
    set primary 8.8.8.8
    set secondary 8.8.4.4
end

# =============================================================================
# FIREWALL POLICIES — Base config with intentional gaps for challenges
# =============================================================================

config firewall policy
    edit 1
        set name "LAN-to-WAN"
        set srcintf "port2"
        set dstintf "port1"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set nat enable
        set logtraffic all
        set comments "Basic outbound - Team ${team_name}"
    next
    edit 2
        set name "DMZ-to-WAN-BLOCKED"
        set srcintf "port3"
        set dstintf "port1"
        set srcaddr "all"
        set dstaddr "all"
        set action deny
        set schedule "always"
        set service "ALL"
        set logtraffic all
        set comments "Challenge: Open Sesame — Fix this policy!"
    next
end

# =============================================================================
# LOGGING — Full logging enabled for challenge validation
# =============================================================================

config log setting
    set fwpolicy-implicit-log enable
    set local-in-allow enable
    set local-in-deny-unicast enable
    set local-out enable
end

config log memory setting
    set status enable
end

config log memory filter
    set severity information
end

# =============================================================================
# FORTIANALYZER — Send logs to central FAZ (Phase 2 challenges)
# =============================================================================
%{ if faz_ip != "" }
config log fortianalyzer setting
    set status enable
    set server "${faz_ip}"
    set upload-option realtime
    set reliable enable
    set certificate-verification disable
    set access-config enable
end
%{ endif }

# =============================================================================
# BROKEN CONFIG — For "The Insider" challenge (applied via separate bootstrap)
# These are activated when challenge_mode = "the_insider"
# =============================================================================
# Issues to plant:
# 1. Wrong default route (points to non-existent gateway)
# 2. DNS set to unreachable servers
# 3. NAT disabled on LAN-to-WAN policy
# 4. HTTPS admin removed from WAN interface
# =============================================================================

${broken_config}

# =============================================================================
# CTF FLAGS — Hidden in various locations
# =============================================================================
${flag_config}
